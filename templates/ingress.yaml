{{- $root := . -}}
{{- $values := .Values -}}
{{- if eq $values.ingress.enabled true -}}
{{- $fullName := include "common.fullname" ( dict "root" $root "service" $values ) -}}
{{- range $hostGroupName, $hostGroupDefinition := $values.ingress.hostGroups }}
---
{{- if semverCompare ">=1.19.0" ( trimPrefix "v" $.Capabilities.KubeVersion.Version ) }}
apiVersion: networking.k8s.io/v1
{{- else if semverCompare ">=1.14-0" $.Capabilities.KubeVersion.GitVersion -}}
apiVersion: networking.k8s.io/v1beta1
{{- else -}}
apiVersion: extensions/v1beta1
{{- end }}
kind: Ingress
metadata:
  name: {{ $fullName }}-{{ $hostGroupName }}
  {{- include "common.metadata" ( dict "root" $ "service" $values ) | nindent 2 }}
spec:
# Add tls only if ingress.tls.enabled is set to true and the other fields are complete.
{{- if and ( hasKey $hostGroupDefinition "tls" ) ( eq $hostGroupDefinition.tls.enabled true ) ( hasKey $hostGroupDefinition.tls "secretName" ) }}
  tls:
    - hosts:
        {{- range $hostGroupDefinition.hosts }}
        - {{ . | quote }}
        {{- end }}
      {{- if $hostGroupDefinition.tls.secretName }}
      secretName: {{ $hostGroupDefinition.tls.secretName }}
      {{- else }}
      secretName: {{ $fullName }}-{{ $hostGroupName }}
      {{- end }}
{{- end }}
  rules:
    {{- range $hostGroupDefinition.hosts }}
    - host: {{ . | quote }}
      http:
        paths:
        {{- range $serviceName, $serviceDefinition := $values.services }}
        {{- if eq $serviceDefinition.enabled true }}
          - path: "{{ $serviceDefinition.ingress.path }}"
            {{- if semverCompare ">=1.14-0" $.Capabilities.KubeVersion.GitVersion }}
            pathType: Prefix
            {{- end }}
            backend:
              {{- if semverCompare ">=1.14-0" $.Capabilities.KubeVersion.GitVersion }}
              service:
                name: {{ include "common.fullname" ( dict "root" $root "service" $serviceDefinition "serviceName" $serviceName ) }}
                port:
                  number: {{ $serviceDefinition.service.servicePort | default 80 }}
              {{- else -}}
              serviceName: {{ include "common.fullname" ( dict "root" $root "service" $serviceDefinition "serviceName" $serviceName ) }}
              servicePort: {{ $serviceDefinition.service.servicePort | default 80 }}
              {{- end -}}


        {{- end }}
        {{- end }}
    {{- end }}
{{- end }}
{{- end }}
